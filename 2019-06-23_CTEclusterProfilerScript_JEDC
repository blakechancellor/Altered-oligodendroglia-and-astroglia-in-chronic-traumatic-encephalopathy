#This script assumes a Seurat analysis has been done.
#If not, initial data must be loaded according to clusterProfiler vignette.

#View clusterProfiler vignette.
browseVignettes("clusterProfiler")


#---------- Initiation ----------


#Load packages.
library(clusterProfiler)
library(data.table)
library(DOSE)
library(enrichplot)
library(ggplot2)
library(org.Hs.eg.db)

#---------- Integrated Data ----------


#Format gene data (convert symbols to Entrez IDs and add average log-fold-change data).
all_genes <- select(org.Hs.eg.db,
                    keys = all_diff_genes$gene_name,
                    columns = c("ENTREZID", "SYMBOL"),
                    keytype = "SYMBOL")
all_genes$avg_logFC <- all_diff_genes$avg_logFC
all_genes <- all_genes[!(is.na(all_genes$ENTREZID)),]

#Format named vector (values are average log-fold-change and names are corresponding Entrez IDs).
all_genes_vec <- all_genes$avg_logFC
names(all_genes_vec) <- as.character(all_genes$ENTREZID)

#Perform gene ontology enrichment analyses.
all_genes_BP <- enrichGO(gene = names(all_genes_vec),
                         OrgDb = org.Hs.eg.db,
                         keyType = "ENTREZID",
                         ont = "BP",
                         readable = TRUE)
all_genes_MF <- enrichGO(gene = names(all_genes_vec),
                         OrgDb = org.Hs.eg.db,
                         keyType = "ENTREZID",
                         ont = "MF",
                         readable = TRUE)
all_genes_CC <- enrichGO(gene = names(all_genes_vec),
                         OrgDb = org.Hs.eg.db,
                         keyType = "ENTREZID",
                         ont = "CC",
                         readable = TRUE)

#Visualize results of analyses.
dotplot(all_genes_BP, showCategory = 20, title = "All_BP")
dotplot(all_genes_MF, showCategory = 20, title = "All_MF")
dotplot(all_genes_CC, showCategory = 20, title = "All_CC")


#---------- OPCs ----------


#Format gene data (convert symbols to Entrez IDs and add average log-fold-change data).
OPC_genes <- select(org.Hs.eg.db, keys = OPCs_diff_genes$gene_name, columns = c("ENTREZID", "SYMBOL"), keytype = "SYMBOL")
OPC_genes$avg_logFC <- OPCs_diff_genes$avg_logFC
OPC_genes <- OPC_genes[!(is.na(OPC_genes$ENTREZID)),]

#Format named vector (values are average log-fold-change and names are corresponding Entrez IDs).
OPC_genes_vec <- OPC_genes$avg_logFC
names(OPC_genes_vec) <- as.character(OPC_genes$ENTREZID)

#Perform gene ontology enrichment analyses.
OPC_genes_BP <- enrichGO(gene = names(OPC_genes_vec),
                         OrgDb = org.Hs.eg.db,
                         keyType = "ENTREZID",
                         ont = "BP",
                         readable = TRUE)
OPC_genes_MF <- enrichGO(gene = names(OPC_genes_vec),
                         OrgDb = org.Hs.eg.db,
                         keyType = "ENTREZID",
                         ont = "MF",
                         readable = TRUE)
OPC_genes_CC <- enrichGO(gene = names(OPC_genes_vec),
                         OrgDb = org.Hs.eg.db,
                         keyType = "ENTREZID",
                         ont = "CC",
                         readable = TRUE)

#Visualize results of analyses.
dotplot(OPC_genes_BP, showCategory = 20, title = "OPC_BP")
dotplot(OPC_genes_MF, showCategory = 20, title = "OPC_MF")
dotplot(OPC_genes_CC, showCategory = 20, title = "OPC_CC")


#---------- Astrocytes ----------


#Format gene data (convert symbols to Entrez IDs and add average log-fold-change data).
astro_genes <- select(org.Hs.eg.db, keys = astros_diff_genes$gene_name, columns = c("ENTREZID", "SYMBOL"), keytype = "SYMBOL")
astro_genes$avg_logFC <- astros_diff_genes$avg_logFC
astro_genes <- astro_genes[!(is.na(astro_genes$ENTREZID)),]

#Format named vector (values are average log-fold-change and names are corresponding Entrez IDs).
astro_genes_vec <- astro_genes$avg_logFC
names(astro_genes_vec) <- as.character(astro_genes$ENTREZID)

#Perform gene ontology enrichment analyses.
astro_genes_BP <- enrichGO(gene = names(astro_genes_vec),
                           OrgDb = org.Hs.eg.db,
                           keyType = "ENTREZID",
                           ont = "BP",
                           readable = TRUE)
astro_genes_MF <- enrichGO(gene = names(astro_genes_vec),
                           OrgDb = org.Hs.eg.db,
                           keyType = "ENTREZID",
                           ont = "MF",
                           readable = TRUE)
astro_genes_CC <- enrichGO(gene = names(astro_genes_vec),
                           OrgDb = org.Hs.eg.db,
                           keyType = "ENTREZID",
                           ont = "CC",
                           readable = TRUE)

#Visualize results of analyses.
dotplot(astro_genes_BP, showCategory = 20, title = "Astrocyte_BP")
dotplot(astro_genes_MF, showCategory = 20, title = "Astrocyte_MF")
dotplot(astro_genes_CC, showCategory = 20, title = "Astrocyte_CC")


#---------- Neurons ----------


#Format gene data (convert symbols to Entrez IDs and add average log-fold-change data).
neuron_genes <- select(org.Hs.eg.db, keys = neurons_diff_genes$gene_name, columns = c("ENTREZID", "SYMBOL"), keytype = "SYMBOL")
neuron_genes$avg_logFC <- neurons_diff_genes$avg_logFC
neuron_genes <- neuron_genes[!(is.na(neuron_genes$ENTREZID)),]

#Format named vector (values are average log-fold-change and names are corresponding Entrez IDs).
neuron_genes_vec <- neuron_genes$avg_logFC
names(neuron_genes_vec) <- as.character(neuron_genes$ENTREZID)

#Perform gene ontology enrichment analyses.
neuron_genes_BP <- enrichGO(gene = names(neuron_genes_vec),
                            OrgDb = org.Hs.eg.db,
                            keyType = "ENTREZID",
                            ont = "BP",
                            readable = TRUE)
neuron_genes_MF <- enrichGO(gene = names(neuron_genes_vec),
                            OrgDb = org.Hs.eg.db,
                            keyType = "ENTREZID",
                            ont = "MF",
                            readable = TRUE)
neuron_genes_CC <- enrichGO(gene = names(neuron_genes_vec),
                            OrgDb = org.Hs.eg.db,
                            keyType = "ENTREZID",
                            ont = "CC",
                            readable = TRUE)

#Visualize results of analyses.
dotplot(neuron_genes_BP, showCategory = 20, title = "Neuron_BP")
dotplot(neuron_genes_MF, showCategory = 20, title = "Neuron_MF")
dotplot(neuron_genes_CC, showCategory = 20, title = "Neuron_CC")
